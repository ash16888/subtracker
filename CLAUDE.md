# Проект "SubTracker"

## 1. Общее описание и цель

**Название проекта:** SubTracker
**Цель:** Создать простое веб-приложение для управления личными подписками. Главная задача — предоставить пользователю наглядный список всех его подписок, чтобы контролировать ежемесячные расходы и вовремя получать напоминания о предстоящих списаниях.

## 2. Основные сущности

### Сущность: Подписка (Subscription)

Каждая запись о подписке содержит следующие поля:

- `id`: `uuid`, первичный ключ, генерируется автоматически
- `name` (Название сервиса): `text`, обязательное. Пример: "Netflix"
- `amount` (Сумма платежа): `number`, обязательное, положительное. Пример: 999
- `currency` (Валюта): `text`, обязательное. Пример: "₽"
- `billing_period` (Период списания): `enum` ('monthly', 'yearly'), обязательное
- `next_payment_date` (Дата следующего платежа): `timestamp with time zone`, обязательное
- `category` (Категория): `text`, опциональное. Предустановленные категории: 'Мультисервис', 'Развлечения', 'Работа', 'ИИ', 'Игры', 'Связь', 'Другое'
- `url` (Ссылка на управление): `text`, опциональное, валидный URL
- `user_id` (ID пользователя): `uuid`, обязательное, ссылка на auth.users
- `google_calendar_event_id` (ID события в Google Calendar): `text`, опциональное
- `created_at` / `updated_at`: временные метки, обновляются автоматически

## 3. Реализованные функциональные возможности

### 3.1. Аутентификация пользователей

**✅ РЕАЛИЗОВАНО:**
- Аутентификация через Google OAuth с Supabase Auth
- Автоматическое получение прав доступа к Google Calendar API
- Контекст аутентификации (AuthContext) для управления состоянием пользователя  
- Защищенные маршруты с проверкой авторизации
- Функции входа, выхода и повторной авторизации Google

**Особенности реализации:**
- Только вход через Google (без email/пароля)
- Запрос разрешений на доступ к Google Calendar при входе
- Сохранение токенов доступа в сессии Supabase

### 3.2. Управление подписками (CRUD)

**✅ РЕАЛИЗОВАНО:**
- **Создание:** Форма добавления подписки с валидацией Zod
- **Чтение:** Список подписок с сортировкой по дате следующего платежа
- **Обновление:** Редактирование существующих подписок
- **Удаление:** Удаление подписок с подтверждением

**Особенности:**
- Форма с полями: название, сумма, валюта, период, дата платежа, категория, URL
- Валидация на уровне формы и схемы данных
- Автоматическое обновление списка после изменений
- Интеграция с Google Calendar для управления напоминаниями

### 3.3. Дашборд и аналитика

**✅ РЕАЛИЗОВАНО:**
- Карточки статистики с общими показателями:
  - Общая сумма расходов за месяц
  - Количество активных подписок
  - Средняя стоимость подписки
  - Самая дорогая подписка
- Круговая диаграмма распределения расходов по категориям
- Список предстоящих платежей
- Фильтрация подписок по категориям

### 3.4. Интеграция с Google Calendar

**✅ РЕАЛИЗОВАНО (новая функциональность):**
- Автоматическое создание напоминаний в Google Calendar
- Напоминания создаются за 3 дня до даты платежа
- Обновление и удаление событий при изменении подписок
- Проверка доступности календаря
- Повторная авторизация при необходимости
- **Автоматическое обновление токенов доступа** (новое)

**Детали:**
- События создаются с описанием и напоминаниями (popup + email)
- Время напоминания: 10:00 в часовом поясе пользователя
- Автоматическое управление жизненным циклом событий
- **Обновление токенов:** При истечении токена (через ~1 час) автоматически запрашивается новый через Google Identity Services
- **Повторные попытки:** При получении 401 ошибки автоматически обновляется токен и повторяется запрос

### 3.5. AI Инсайты и рекомендации

**✅ ПОЛНОСТЬЮ РЕАЛИЗОВАНО И РАБОТАЕТ:**
- Новая вкладка "AI Инсайты" в главном интерфейсе
- **Реальный AI анализ** с помощью OpenAI o3 модели через Supabase Edge Function
- Генерация персонализированных рекомендаций на основе реальных данных
- Визуализация потенциальной экономии и детальные планы действий

**Формат AI анализа:**
- **Персональный подход:** Связный текстовый анализ вместо отдельных инсайтов
- **Дружелюбный тон:** AI выступает как персональный финансовый консультант
- **Структурированный контент:** Приветствие → Анализ → Рекомендации → Заключение
- **Органичные советы:** Оптимизация, дубликаты и новые предложения интегрированы в текст
- **Персонализация:** Анализ основан на конкретных подписках и интересах пользователя
- **Практические действия:** Конкретные суммы экономии и actionable рекомендации

**Архитектура AI системы:**
- **Supabase Edge Function** с OpenAI o3 API интеграцией
- **Reasoning Model** с параметром `reasoning_effort: medium`
- **Автоматический fallback** на демо-режим при недоступности API
- **Безопасное хранение** API ключей в Supabase Vault
- **Умная обработка ответов** с очисткой markdown и валидацией JSON

**Особенности реализации:**
- ✅ **Реальный AI анализ** через OpenAI o3 reasoning model
- ✅ **Текстовый формат** - связный персональный анализ вместо карточек инсайтов
- ✅ **Демо-режим** как fallback с клиентским анализом  
- ✅ **Dual-mode operation** - автоматическое переключение между режимами
- ✅ **Персонализированный тон** - дружелюбный консультант, а не формальный отчет
- ✅ **Безопасность** - все API ключи на сервере, не в клиенте
- ✅ **Обработка ошибок** - детальное логирование и graceful degradation
- ✅ **Демо-страница** без авторизации (/demo) с тестовыми данными
- ✅ **Интеграция** с главной навигацией и аутентификацией

## 4. Текущий технологический стек

- **Фронтенд:** React 19.1.0 + TypeScript
- **Роутинг:** React Router DOM 6.21.1
- **Стилизация:** Tailwind CSS 3.4.0
- **Формы:** React Hook Form 7.48.2 + Zod 3.22.4 валидация
- **Состояние сервера:** TanStack React Query 5.17.0
- **Бэкенд:** Supabase
  - **Auth:** Google OAuth с доступом к Calendar API
  - **Database:** PostgreSQL с Row Level Security
  - **Real-time:** Подписки на изменения данных
- **Внешние API:** Google Calendar API v3
- **Утилиты:** date-fns 3.0.6 для работы с датами
- **Сборка:** Vite 6.3.5

## 5. Архитектура проекта

### Структура каталогов:
```
src/
├── components/          # Переиспользуемые компоненты
├── features/           # Функциональные модули
│   ├── auth/          # Аутентификация
│   ├── subscriptions/ # Управление подписками
│   ├── calendar/      # Интеграция с календарем
│   └── ai-insights/   # AI анализ и рекомендации
├── pages/             # Страницы приложения
├── lib/               # Конфигурация библиотек
├── services/          # Внешние сервисы
├── types/             # TypeScript типы
└── utils/             # Вспомогательные функции
```

### Основные страницы:
- `LoginPage` - вход через Google (со ссылкой на демо)
- `DashboardPage` - главная страница с аналитикой
- `UpcomingPaymentsPage` - предстоящие платежи
- `AIInsightsPage` - AI инсайты и рекомендации
- `DemoAIInsightsPage` - демо AI инсайтов без авторизации (/demo)

### Безопасность:
- Row Level Security (RLS) в Supabase
- Политики доступа только к собственным данным
- Валидация данных на клиенте и сервере
- Безопасное хранение токенов OAuth

## 6. База данных

### Таблица `subscriptions`:
```sql
CREATE TABLE subscriptions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name TEXT NOT NULL,
    amount DECIMAL(10, 2) NOT NULL CHECK (amount > 0),
    currency TEXT NOT NULL,
    billing_period TEXT NOT NULL CHECK (billing_period IN ('monthly', 'yearly')),
    next_payment_date TIMESTAMP WITH TIME ZONE NOT NULL,
    category TEXT,
    url TEXT,
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    google_calendar_event_id TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```
### Индексы:
- `idx_subscriptions_user_id` - для быстрых запросов по пользователю
- `idx_subscriptions_next_payment_date` - для сортировки по дате

### Триггеры:
- Автоматическое обновление `updated_at` при изменении записи

## 7. Команды разработки
- `npm run dev` - запуск в режиме разработки
- `npm run build` - сборка для продакшена
- `npm run typecheck` - проверка типов TypeScript
- `npm run lint` - проверка кода ESLint
- `npm run preview` - предварительный просмотр сборки